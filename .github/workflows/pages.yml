name: Deploy Docs to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        if: ${{ hashFiles('go.mod') != '' }}
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'

      - name: Setup Node
        if: ${{ hashFiles('package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup PHP
        if: ${{ hashFiles('composer.json') != '' }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Build SDK Reference Docs (Go)
        if: ${{ hashFiles('go.mod') != '' }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p docs/reference
          go install github.com/princjef/gomarkdoc/cmd/gomarkdoc@latest
          gomarkdoc --output docs/reference/index.md ./...
          cat > docs/reference/index.html <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
            <head>
              <meta charset="utf-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1" />
              <title>Go SDK Reference</title>
              <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.5.1/github-markdown.min.css" />
              <style>
                body { margin: 0; background: #0b1220; }
                .topbar { padding: 14px 18px; background: #0f172a; color: #e5e7eb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
                .topbar a { color: #93c5fd; text-decoration: none; margin-right: 12px; }
                .container { max-width: 1100px; margin: 0 auto; padding: 22px; }
                .markdown-body { background: #ffffff; padding: 28px; border-radius: 12px; }
              </style>
            </head>
            <body>
              <div class="topbar">
                <a href="../index.html">API Explorer</a>
                <a href="../sdk.html">SDK Guides</a>
                <a href="../api-v2.html">API Docs</a>
              </div>
              <div class="container">
                <article id="content" class="markdown-body"></article>
              </div>
              <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
              <script>
                (async function () {
                  const target = document.getElementById('content');
                  const resp = await fetch('./index.md');
                  const md = await resp.text();
                  target.innerHTML = marked.parse(md);
                })();
              </script>
            </body>
          </html>
          EOF

      - name: Build SDK Reference Docs (TypeScript)
        if: ${{ hashFiles('package.json') != '' }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p docs/reference
          npm ci || npm install
          npx --yes typedoc --out docs/reference --entryPoints src/index.ts

      - name: Build SDK Reference Docs (PHP)
        if: ${{ hashFiles('composer.json') != '' }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p docs/reference
          composer install --no-interaction --no-progress --prefer-dist
          composer global require phpdocumentor/phpdocumentor
          PHPDOC_BIN="$HOME/.composer/vendor/bin/phpdoc"
          if [ ! -x "$PHPDOC_BIN" ]; then
            PHPDOC_BIN="$HOME/.config/composer/vendor/bin/phpdoc"
          fi
          "$PHPDOC_BIN" -d src -t docs/reference

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
